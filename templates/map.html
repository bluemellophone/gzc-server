{% extends "layout.html" %}
{% block content %}

    <style type="text/css">
        body
        {
            overflow-y: hidden;
            background-color: #ececec;
        }

        #gps-map-image
        {
            width: 100%;
            position: absolute !important;
            top: 0;
            left: 0;
        }

        #gps-map-points
        {
            width: 100%;
            height: 100%;
        }

        #gps-map-points .point
        {
            position: absolute !important;
            height: 3px;
            width: 3px;
            border-radius: 3px;
            top: -3px;
            left: -3px;
        }

        .content
        {
            margin-top: 0px;
        }

        .header, .footer
        {
            display: none;
        }
    </style>

    <script type="text/javascript">
        var bounds = {"Ca":{"k":-1.4453662695101237,"j":-1.2789018455871297},"va":{"j":36.71580444335939,"k":36.99835906982423}};
        var b1 = bounds['Ca']['j']
        var b2 = bounds['Ca']['k']
        var b3 = bounds['va']['j']
        var b4 = bounds['va']['k']
        var boundsTL = [b1, b3]
        var boundsBR = [b2, b4]

        var track = {};
        var markers = {};
        {% if offset %}
            var offset = {{ offset }};
        {% else %}
            var offset = undefined;
        {% endif %}
        var image_width = 0;
        var image_height = 0;

        $( window ).load( function() {
            initValues();
            centerMap();

            {% if data %}
                {% autoescape false %}
                    var data = $.parseJSON('{{ data }}');
                {% endautoescape %}
                var last = undefined;
                $.each( data.track, function( key, marker ) {
                    if(last === undefined)
                    {
                        last = marker.time;
                        console.log("TRACK FIRST: " + last);
                    }
                    else
                    {
                        last = marker.time;   
                    }
                    track[last] = [marker.lat, marker.lon];
                });
                console.log("TRACK LAST: " + last);
                drawTrack(track);
            {% endif %}
        });

        function initValues()
        {
            viewport_height = $( window.top ).height();
            var img = document.getElementById('gps-map-image');
            image_width = img.clientWidth;
            image_height = img.clientHeight;
            console.log("Image: " + viewport_height + " " + image_height);
            // Assign offset, if not given by GET
            temp = -1 * (image_height - viewport_height) / 2;
            // temp = 0;   
            offset = undef(offset, temp);
        }

        function centerMap()
        {
            $("#gps-map-image").css("top", offset + 'px');
        }

        function drawTrack(track)
        {
            $('#gps-map-points').html('');
            var mapWidth = Math.abs(boundsBR[1] - boundsTL[1])
            var mapHeight = Math.abs(boundsBR[0] - boundsTL[0])
            console.log("MAP WIDTH:  " + mapWidth);
            console.log("MAP HEIGHT: " + mapHeight);

            var point;
            for(var index in track)
            {
                point = track[index];
                // point
                lat_orig = point[0];
                lon_orig = point[1];
                // console.log(lat + " " + lon);
                // offset to map origin
                lat = lat_orig - boundsTL[0];
                lon = lon_orig - boundsTL[1];
                // console.log(lat + " " + lon);
                // offset to map origin
                lat /= mapHeight;
                lon /= mapWidth;
                // console.log(lat + " " + lon);
                // abs percentage
                lat = Math.abs(lat);
                lon = Math.abs(lon);
                // console.log(lat + " " + lon);
                // find pixel absolute offset
                lat *= image_height;
                lon *= image_width;
                // console.log(lat + " " + lon);
                // fix height due to offset
                lat += offset;

                if(insidePoly(undefined, [lon_orig, lat_orig]))
                    color = "#428BCA";
                else
                    color = "#FF0000";

                $('#gps-map-points').append('<div class="point" style="top: ' + lat + 'px; left: ' + lon + 'px; background-color: ' + color + ';"></div>');
            }
        }
    </script>

    <img id="gps-map-image" src="{{ url_for('static', filename='images/map_nairobi.png') }}"/>
    <div id="gps-map-points">
        <div class="point"></div>
    </div>

{% endblock %}