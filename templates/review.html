{% extends "layout.html" %}
{% block content %}
    {% if not valid %}
        <div class="jumbotron" style="text-align: center; position: relative;">
            <h3>OOPS...</h3>
            <p>
                The car and person you tried to review has not been processed yet by IBEIS.
                <br/>
                <br/>
                Please try again later.
            </p>
            <a href="?override" style="position: absolute; bottom: 10px; right: 10px; color: #333;">
                <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
            </a>
        </div>
    {% else %}
        <script type="text/javascript">
            var selected = new Array();
            var track = {};
            var markers = {};
            var empty = '{{ url_for('static', filename='images/empty.jpg') }}';

            $( window ).ready( function() {
                $(".analysis-image-hover-container").mouseenter(function() {
                    analysis = $(this).attr("analysis");       
                    $(this).animate({ backgroundColor: "#CCC", }, 500);
                    $("#analysis-image-correspondences-" + analysis).animate({ left: "0", }, 500);
                });

                $(".analysis-image-hover-container").mouseleave(function() {
                    analysis = $(this).attr("analysis");          
                    $(this).animate({ backgroundColor: "transparent", }, 500);
                    $("#analysis-image-correspondences-" + analysis).animate({ left: "-100%", }, 500);
                });

                toggleAnalysis('{{ person }}-0', false);
                toggleAnalysis('{{ person }}-1', false);
                toggleAnalysis('{{ person }}-2', false);
            });

            function findClosestTime(metadata_time)
            {
                var index;
                for( index in track )
                {
                    if(metadata_time < index)
                    {
                        return index;
                    }
                }
                return index;
            }

            function updateCandidates()
            {
                var version = 2; // UPDATE CSS VALUES
                var template = '' + 
                    '<h4>Image: {0}</h4>' + 
                    '<p>Time: {1}</p>' + 
                '';
                markers = {};
                for( var i = 0; i < 3; i++ )
                {
                    if(i < selected.length)
                    {
                        var candidate = selected[i];
                        var analysis = $("#analysis-" + candidate);
                        var metadata_time = analysis.attr("metadata-original-image-unixtime");
                        metadata_time = Number.parseFloat(metadata_time);
                        console.log(candidate + " " + metadata_time);
                        var close = findClosestTime(metadata_time);
                        markers[i] = track[close];

                        if(version == 1)
                        {
                            content = template.format(
                                analysis.attr("metadata-original-image-gname"), 
                                analysis.attr("metadata-original-image-unixtime")
                            );
                            $("#candidate-information-" + i).html(content); 
                        }
                        else if(version == 2)
                        {
                            content_top = template.format(
                                analysis.attr("metadata-match-image-gname"), 
                                analysis.attr("metadata-match-image-unixtime")
                            );
                            content_bottom = template.format(
                                analysis.attr("metadata-original-image-gname"), 
                                analysis.attr("metadata-original-image-unixtime")
                            );
                            $("#candidate-information-" + i + " .candidate-information-top").html(content_top); 
                            $("#candidate-information-" + i + " .candidate-information-bottom").html(content_bottom);  
                        }

                        $("#candidate-image-original-" + i + " img").attr('src', $("#analysis-image-original-" + candidate + " img").attr('src') );
                        $("#candidate-image-match-" + i + " img").attr('src', $("#analysis-image-correspondences-" + candidate + " img").attr('src') );
                    }
                    else
                    {
                        if(version == 1)
                        {
                            $("#candidate-information-" + i).html('<h4>Select an Analysis</h4>');   
                        }
                        else if(version == 2)
                        {
                            $("#candidate-information-" + i + " .candidate-information-top").html('<h4>Select an Analysis</h4>');   
                            $("#candidate-information-" + i + " .candidate-information-bottom").html('<h4>Select an Analysis</h4>');   
                        }
                        $("#candidate-image-original-" + i + " img").attr('src', empty);
                        $("#candidate-image-match-" + i + " img").attr('src', empty);
                    }
                }
                // renderMap();
            }

            function toggleAnalysis(analysis, is_new)
            {
                console.log("NEW: " + is_new);
                if(selected.indexOf(analysis) > -1)
                {
                    removeFromArray(analysis, selected)
                    $("#analysis-" + analysis).removeClass('analysis-selected');
                    $("#analysis-" + analysis + " div span.glyphicon.glyphicon-heart").addClass('glyphicon-heart-empty');
                    updateCandidates();
                }
                else
                {
                    while(selected.length >= 3)
                    {
                        var popped = selected[0];
                        removeFromArray(popped, selected);
                        $("#analysis-" + popped).removeClass('analysis-selected');
                        $("#analysis-" + popped + " div span.glyphicon.glyphicon-heart").addClass('glyphicon-heart-empty');
                        updateCandidates();
                    }

                    if(selected.length < 3)
                    {
                        selected.push(analysis);
                        $("#analysis-" + analysis).addClass('analysis-selected');
                        $("#analysis-" + analysis + " div span.glyphicon.glyphicon-heart").removeClass('glyphicon-heart-empty');
                        updateCandidates();
                    }
                    else
                    {
                        $("#analysis-" + analysis + " div span.glyphicon").animate({ color: "#d9534f", }, 200).delay(200).animate({ color: "#333", }, 200);;
                    }
                }

                if(selected.length >= 1)
                {
                    $("#send-button").removeAttr('disabled');
                }
                else
                {
                    $("#send-button").attr('disabled','disabled'); 
                }
                console.log(selected);
            }

            function clearSelected()
            {
                selected = new Array();
                updateCandidates();
                $(".analysis").removeClass('analysis-selected');
                $(".analysis div span.glyphicon.glyphicon-heart").addClass('glyphicon-heart-empty');
            }
        </script>

        <style type="text/css">
            .container
            {
                width: 100%;
            }
        </style>

        <div class="row" id="splitter">
            <div class="col-md-6" id="content-left" style="padding-left: 50px;">
                <ul class="nav nav-tabs" role="tablist">
                    {% for letter in analysis_dict.keys() %}
                        {% if letter == person %}
                            <li role="presentation" class="active"><a href="#person-{{ letter }}" aria-controls="person-{{ letter }}" role="tab" data-toggle="tab">{{ letter }}</a></li>
                        {% else %}
                            <li role="presentation"><a href="#person-{{ letter }}" aria-controls="person-{{ letter }}" role="tab" data-toggle="tab">{{ letter }}</a></li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <div>
                    <a onclick="clearSelected();" class="btn btn-danger" style="position: absolute; top: 0px; right: 0px; margin-right: 15px;">CLEAR</a>
                </div>
                <div class="tab-content">
                {% for letter in analysis_dict.keys() %}
                    {% if letter == person %}
                        <div role="tabpanel" class="tab-pane active" id="person-{{ letter }}">
                    {% else %}
                        <div role="tabpanel" class="tab-pane" id="person-{{ letter }}">
                    {% endif %}
                        <div class="analysis-container">
                            {% for (i, conf, correspondences, original, match, metadata) in analysis_dict[letter][:5] %}
                                <div class="row analysis" id="analysis-{{ letter }}-{{ i }}" analysis="{{ letter }}-{{ i }}" {{ metadata }}>                  
                                    <div class="col-xs-10 col-sm-10 col-md-10 analysis-image-correspondences" id="analysis-image-correspondences-{{ letter }}-{{ i }}">
                                        <img src="{{ correspondences }}" />
                                        <p style="color: #fff;">Confidence: {{ conf }}</p>
                                    </div>   
                                    <div class="col-xs-5 col-sm-5 col-md-5 analysis-image-original" id="analysis-image-original-{{ letter }}-{{ i }}">
                                        <img src="{{ original }}" />
                                    </div>
                                    <div class="col-xs-5 col-sm-5 col-md-5 analysis-image-match" id="analysis-image-match-{{ letter }}-{{ i }}">
                                        <img src="{{ match }}" />
                                    </div>
                                    <div class="col-xs-2 col-sm-2 col-md-2 analysis-image-hover-container" analysis="{{ letter }}-{{ i }}">
                                        <div class="analysis-image-hover" onclick="toggleAnalysis('{{ letter }}-{{ i }}', false);"  id="analysis-image-hover-{{ letter }}-{{ i }}" analysis="{{ letter }}-{{ i }}" style="width: 100%; height: 50%;">
                                            <span class="glyphicon glyphicon-heart glyphicon-heart-empty" aria-hidden="true"></span>
                                        </div>
                                        <br/>
                                        <div class="analysis-image-new" onclick="toggleAnalysis('{{ letter }}-{{ i }}', true);"  style="width: 100%; height: 50%; margin-top: 10px;">
                                            <span class="glyphicon glyphicon-asterisk" aria-hidden="true"></span> 
                                        </div>
                                    </div>  
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                </div>
                <div class="send-container">
                    <a class="btn btn-xl btn-primary" id="send-button" onclick="submitPDF('{{ car_str }}', '{{ person }}')" disabled="disabled">PRINT</a>
                </div>
            </div>

            <div class="col-md-6" id="content-right">
                <div class="printarea">
                    <div class="printarea-document">
                        <!-- 
                            <div id="content-container" class="us-letter" style="margin-left:auto; margin-right:auto; margin-top:0px; border: 1px solid #ddd;"> 
                        -->
                        <div id="content-container" class="a4-letter" style="margin-left:auto; margin-right:auto; margin-top:0px; border: 1px solid #ddd;">
                            <div style="background-color:#fff; height:100%; widht:100%; padding: 35px 50px;">
                                
                                <div class="row" style="height:10%;">
                                    <div class="col-xs-8 col-sm-8 col-md-8 notice-cell">
                                        <img src="{{ url_for('static', filename='images/logo_ibeis.png') }}" style="width: 110px; margin-top: -70px; margin-left: -10px; margin-right: 10px;"/>
<!--                                         
                                        <img src="{{ url_for('static', filename='images/logo_kwf.png') }}" style="width: 110px; margin-top: -70px; margin-left: -10px; margin-right: 10px;"/>
                                        
                                        <img src="{{ url_for('static', filename='images/logo_kws.png') }}" style="width: 110px; margin-top: -70px; margin-left: -10px; margin-right: 10px;"/> 
-->                                        
  
                                        <div style="display:inline-block; font-size:20px; margin-top:-10px;">
                                            <h3 style="line-height: 35px;">
                                            The Great Zebra &amp; <br/>
                                            Giraffe Count
                                            </h3>
                                        </div> 


                                    </div>

                                    <div class="col-xs-4 col-sm-4 col-md-4 notice-cell">
                                        <div style="text-transform:uppercase;">
                                            
                                        </div>
                                        <div class="identification-container checkered identification-color-{{ car_color }}">
                                            {% autoescape false %}
                                                {{ car_number }}
                                            {% endautoescape %}
                                            {{ car_color }} {{ person }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row" style="height:27%; margin: 0px;">
                                    <!-- <div id="gps-map-canvas"></div> -->
                                    <div style="height: 100%; width: 100%; overflow: hidden;"> 
                                        <object id="gps-map-canvas" type="text/html" data="{{ url_for('map') }}?offset=-110&car_str={{ car_str }}" style="width: 100%; overflow: hidden;"></object>
                                    </div>
                                    <div id="map-legend">
                                        <div class="candidate-black"></div> 1<sup>st</sup> Image Locations
                                        <br/>
                                        <div class="candidate-red"></div> 2<sup>nd</sup> Image Locations
                                        <br/>
                                        <div class="candidate-green"></div> 3<sup>rd</sup> Image Locations
                                        <br/>
                                    </div>
                                </div>

                                <div class="row candidate" style="height:2%; margin-top:1%;">
                                    <div class="col-xs-4 col-sm-4 col-md-4 candidate-image-original" id="candidate-image-original-{{ i }}" style="color: #999 !important; font-style: italic; background-color: transparent !important; border: none !important;">
                                        Your Image
                                    </div>
                                    <div class="col-xs-8 col-sm-8 col-md-8 candidate-image-match" id="candidate-image-match-{{ i }}" style="color: #999 !important; font-style: italic; background-color: transparent !important; border: none !important;">
                                        Matched Image
                                    </div>
                                </div>

                                {% for (i, color) in [(0, 'black'), (1, 'red'), (2, 'green')] %}
                                    <div class="row candidate" id="candidate-match-{{ i }}" style="height:19%; margin-bottom:1%">
                                        <div class="col-xs-4 col-sm-4 col-md-4 candidate-image-original" id="candidate-image-original-{{ i }}">
                                            <p>IMAGE NAME</p>
                                            <div class="candidate-{{ color }}">
                                                <img src="" />
                                            </div>
                                            <p>IMAGE TIME</p>
                                        </div>
                                        <div class="col-xs-8 col-sm-8 col-md-8 candidate-image-match" id="candidate-image-match-{{ i }}">
                                            <p>MATCH NAME</p>
                                            <img src="" />
                                            <p>FRIST SEEN TIME, FIRST SEEN LOCATION</p>
                                        </div>
                                    </div>

                                    <!-- <div class="row candidate" id="candidate-new-{{ i }}" style="height:19%; margin-bottom:1%">
                                        <div class="col-xs-4 col-sm-4 col-md-4 candidate-image-original" id="candidate-image-original-{{ i }}">
                                            <p>IMAGE NAME</p>
                                            <div class="candidate-{{ color }}">
                                                <img src="" />
                                            </div>
                                            <p>IMAGE TIME</p>
                                        </div>
                                        <div class="col-xs-8 col-sm-8 col-md-8 candidate-image-match" id="candidate-image-match-{{ i }}">
                                            <h2 style="margin-top: 10px; color: #428BCA !important;">Congratulations!</h2>
                                            <p>You found a new animal!  This animal has been seen first <b>by you</b>.</p>
                                            <h4 style="text-align: left; margin-bottom: 0px; padding-left: 17px;">First Seen On: FIRST SEEN TIME </h4>
                                            <h4 style="text-align: left; margin-top: 0px; padding-left: 17px;">First Seen At: LAT, LON</h4>
                                            <i><h3 style="margin-top: 0px; color: #999;">Asante sana and come ujibambe!</h3></i>  
                                        </div>
                                    </div> -->
                                {% endfor %}

                                <div class="row" style="height:1%; text-align: center; color: #aaa !important; font-style: italic;">
                                    visit ibeis.org for more information
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}